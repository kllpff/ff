# Конфигурация доверенных прокси

Когда ваше приложение развернуто за обратным прокси (nginx, Cloudflare, AWS ALB, Docker и др.), вы должны настроить доверенные прокси для обеспечения правильной работы и безопасности.

## Почему важны доверенные прокси

Без правильной конфигурации ваше приложение будет:
- **Определять неправильные IP-адреса клиентов** (будет показывать IP прокси вместо реального IP пользователя)
- **Генерировать некорректные URL** в письмах, редиректах и API ответах
- **Ломать ограничение частоты запросов** и другие функции безопасности, зависящие от IP клиента
- **Не определять HTTPS** когда SSL завершается на уровне прокси

## Методы конфигурации

### Метод 1: Переменные окружения (.env)

Добавьте в ваш файл `.env`:

```bash
# Один прокси
TRUSTED_PROXIES=192.168.1.1

# Несколько прокси (через запятую)
TRUSTED_PROXIES=192.168.1.1,192.168.1.2,10.0.0.5

# Диапазоны сетей (CIDR нотация)
TRUSTED_PROXIES=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16

# Все частные сети (обычно для Docker)
TRUSTED_PROXIES=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
```

### Метод 2: Файл конфигурации

Отредактируйте `config/app.php`:

```php
return [
    // ... другие настройки ...
    
    'trusted_proxies' => [
        '192.168.1.1',
        '192.168.1.2',
        '10.0.0.0/8',
        '172.16.0.0/12',
        '192.168.0.0/16'
    ],
];
```

## Конфигурации популярных сервисов

### Cloudflare

```bash
# IP-диапазоны Cloudflare (2024)
TRUSTED_PROXIES=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22
```

### AWS Application Load Balancer (ALB)

```bash
# ALB в VPC (замените на вашу фактическую подсеть ALB)
TRUSTED_PROXIES=10.0.0.0/16

# Или конкретный IP ALB (проверьте консоль AWS для фактического IP)
TRUSTED_PROXIES=10.0.1.5,10.0.2.5
```

### Docker Compose

```bash
# Сеть Docker по умолчанию
TRUSTED_PROXIES=172.17.0.0/16

# Пользовательская сеть Docker compose
TRUSTED_PROXIES=192.168.0.0/20
```

### Nginx Reverse Proxy

```bash
# Когда nginx на том же сервере
TRUSTED_PROXIES=127.0.0.1

# Когда nginx на другом сервере
TRUSTED_PROXIES=192.168.1.100
```

## Лучшие практики безопасности

### ❌ Никогда не делайте это в продакшене

```bash
# ОПАСНО: Доверяет ВСЕМ прокси (никогда не используйте в продакшене!)
TRUSTED_PROXIES=*
```

### ✅ Вместо этого делайте это

1. **Будьте конкретны**: Всегда указывайте точные IP-адреса или диапазоны сетей
2. **Используйте CIDR нотацию**: Для диапазонов сетей (например, `192.168.1.0/24`)
3. **Регулярные обновления**: Поддерживайте списки IP прокси в актуальном состоянии (особенно для Cloudflare)
4. **Специфичные окружения**: Используйте разные настройки для development/staging/production

## Тестирование вашей конфигурации

Создайте тестовый скрипт `test-proxy.php`:

```php
<?php
require_once __DIR__ . '/vendor/autoload.php';

$app = require_once __DIR__ . '/bootstrap/app.php';

$request = $app->make('request');

echo "IP клиента: " . $request->ip() . PHP_EOL;
echo "HTTPS: " . ($request->isSecure() ? 'Да' : 'Нет') . PHP_EOL;
echo "Порт сервера: " . $request->getPort() . PHP_EOL;
echo "Хост: " . $request->getHost() . PHP_EOL;
echo "Схема: " . $request->getScheme() . PHP_EOL;
```

Запустите тест:
```bash
php test-proxy.php
```

## Устранение неполадок

### Все еще получаете неправильный IP?

1. **Проверьте заголовки прокси**: Убедитесь, что ваш прокси отправляет правильные заголовки:
   - `X-Forwarded-For` (IP клиента)
   - `X-Forwarded-Proto` (http/https)
   - `X-Forwarded-Port` (номер порта)

2. **Проверьте конфигурацию**: Убедитесь, что IP-адреса прокси правильные:
   ```bash
   # Проверьте реальный IP nginx
   tail -f /var/log/nginx/access.log
   
   # Проверьте, что видит ваше приложение
   php -r "echo \$_SERVER['REMOTE_ADDR'];"
   ```

3. **Сети Docker**: В Docker используйте имена контейнеров или внутренние сети:
   ```bash
   # Используйте имя контейнера nginx
   TRUSTED_PROXIES=nginx
   
   # Или шлюз сети Docker
   TRUSTED_PROXIES=172.18.0.1
   ```

### HTTPS не определяется?

Добавьте в конфигурацию nginx:
```nginx
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Port $server_port;
```

### Проблемы с ограничением частоты запросов?

Убедитесь, что ваше промежуточное ПО использует правильное определение IP клиента. Фреймворк автоматически использует реальный IP клиента, когда настроены доверенные прокси.

## Связанная конфигурация

### Разрешенные хосты

Всегда настраивайте разрешенные хосты для безопасности:

```bash
# Файл .env
APP_ALLOWED_HOSTS=example.com,www.example.com,api.example.com
```

### За балансировщиком нагрузки

Если используются проверки состояния, добавьте внутренние IP:
```bash
# Проверки состояния AWS ALB
TRUSTED_PROXIES=10.0.0.0/8,127.0.0.1
```

## Распространенные настройки

### Разработка (Локальный Docker)
```bash
TRUSTED_PROXIES=172.17.0.0/16,127.0.0.1
```

### Стажинг (Cloudflare + Nginx)
```bash
TRUSTED_PROXIES=173.245.48.0/20,103.21.244.0/22,192.168.1.100
```

### Продакшен (AWS ALB + Cloudflare)
```bash
TRUSTED_PROXIES=10.0.0.0/16,173.245.48.0/20,103.21.244.0/22
```

## Поддерживайте в актуальном состоянии

- **IP Cloudflare**: Проверяйте https://www.cloudflare.com/ips/
- **AWS ALB**: Отслеживайте ваши фактические IP-адреса ALB
- **Docker**: Проверяйте ваши пользовательские конфигурации сетей